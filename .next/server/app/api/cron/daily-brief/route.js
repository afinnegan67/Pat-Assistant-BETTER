"use strict";(()=>{var e={};e.id=706,e.ids=[706],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},7829:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>k,requestAsyncStorage:()=>_,routeModule:()=>h,serverHooks:()=>v,staticGenerationAsyncStorage:()=>O});var a={};r.r(a),r.d(a,{GET:()=>w,POST:()=>y});var n=r(9303),i=r(8716),o=r(670),s=r(7070),c=r(2113),l=r(1491),d=r(9313),u=r(3240);let p=`You generate Patrick's daily morning brief. You receive:
- Today's tasks (with deadlines and priorities)
- Overdue tasks
- Today's calendar events
- Upcoming project milestones

Generate a concise morning brief that:
1. Leads with the most urgent items
2. Lists what's due today
3. Lists overdue items that need attention
4. Mentions any calendar events
5. Ends with a count summary

Keep it scannable. No fluff. Patrick is reading this at 6am before his day starts.

Example tone:
"Morning. 4 tasks due today, 2 overdue from last week.

Due today:
- Send Chen change order (high priority)
- Call inspector for Hubble
- Order materials for Johnson deck
- Submit receipts

Overdue:
- Return $600 item to Home Depot (3 days)
- Follow up with Manny on drywall (5 days)

Calendar: 9am client meeting at Chen site, 2pm admin meeting.

Total open tasks: 23 across 8 projects."`;async function m(){try{let[e,t,r,a,n]=await Promise.all([(0,d.hR)(),(0,d.yJ)(),(0,d.TK)(),(0,d.AF)(),(0,u.Py)().catch(()=>[])]),i=e.length>0?e.map(e=>`- ${function(e){let t=[e.description];return("high"===e.priority||"urgent"===e.priority)&&t.push(`(${e.priority} priority)`),t.join(" ")}(e)}`).join("\n"):"No tasks due today.",o=t.length>0?t.map(e=>`- ${function(e){if(!e.deadline)return e.description;let t=new Date(e.deadline),r=Math.floor((new Date().getTime()-t.getTime())/864e5);return`${e.description} (${r} day${1===r?"":"s"} overdue)`}(e)}`).join("\n"):"No overdue tasks.",s=n.length>0?(0,u.Pl)(n):"No calendar events today.",{text:m}=await (0,c._4)({model:l.bt,system:p,prompt:`Today's tasks (${e.length}):
${i}

Overdue tasks (${t.length}):
${o}

Calendar events:
${s}

Total open tasks: ${r.length}
Active projects: ${a.length}

Generate the morning brief.`}),f=[...e.map(e=>e.id),...t.map(e=>e.id)];return{content:m.trim(),taskIds:f}}catch(e){return console.error("Briefing generation error:",e),{content:"Your nephew Aidan failed to build me correctly. Blame him not me.",taskIds:[]}}}var f=r(2126);let g=process.env.CRON_SECRET;async function w(e){try{if(g&&e.headers.get("authorization")!==`Bearer ${g}`)return s.NextResponse.json({error:"Unauthorized"},{status:401});await (0,d.Kv)();let{content:t,taskIds:r}=await m(),a=new Date().toISOString().split("T")[0];try{await (0,d.iY)({brief_date:a,content:t,tasks_included:r})}catch(e){console.log("Brief may already exist for today:",e)}return await (0,f._b)(t),s.NextResponse.json({success:!0,date:a,tasksIncluded:r.length})}catch(e){console.error("Daily brief error:",e);try{await (0,f._b)("Your nephew Aidan failed to build me correctly. Blame him not me. (Daily brief failed)")}catch(e){console.error("Failed to send error notification:",e)}return s.NextResponse.json({error:"Daily brief failed",details:e.message},{status:500})}}async function y(e){return w(e)}let h=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/cron/daily-brief/route",pathname:"/api/cron/daily-brief",filename:"route",bundlePath:"app/api/cron/daily-brief/route"},resolvedPagePath:"C:\\Users\\aidan\\OneDrive\\Documents\\Pats Assitant Improved\\app\\api\\cron\\daily-brief\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:O,serverHooks:v}=h,$="/api/cron/daily-brief/route";function k(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:O})}},9313:(e,t,r)=>{r.d(t,{$3:()=>P,$L:()=>v,AF:()=>T,E5:()=>_,Kv:()=>i,ME:()=>F,RJ:()=>o,Rp:()=>k,TK:()=>f,W9:()=>m,Wl:()=>u,Yw:()=>S,_i:()=>n,fP:()=>y,hR:()=>w,iY:()=>A,ib:()=>E,kD:()=>c,km:()=>O,pj:()=>h,tR:()=>b,ty:()=>$,vr:()=>l,xJ:()=>d,yJ:()=>g,yW:()=>p,zE:()=>s,zx:()=>j});var a=r(964);async function n(){let{data:e,error:t}=await a.O.rpc("get_or_create_conversation");if(t)throw Error(`Failed to get/create conversation: ${t.message}`);return e}async function i(){let{error:e}=await a.O.rpc("close_old_conversations");if(e)throw Error(`Failed to close old conversations: ${e.message}`)}async function o(e){let{data:t,error:r}=await a.O.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(r)throw Error(`Failed to get messages: ${r.message}`);return t}async function s(e,t,r,n){let{data:i,error:o}=await a.O.from("messages").insert({conversation_id:e,role:t,content:r,active_context:n}).select().single();if(o)throw Error(`Failed to save message: ${o.message}`);return await a.O.from("conversations").update({last_activity:new Date().toISOString()}).eq("id",e),i}async function c(e){let{data:t,error:r}=await a.O.from("messages").select("active_context").eq("conversation_id",e).order("created_at",{ascending:!1}).limit(1).single();return r||!t?null:t.active_context}async function l(e){let{data:t,error:r}=await a.O.from("tasks").insert({description:e.description,project_id:e.project_id||null,deadline:e.deadline||null,priority:e.priority||"medium",is_recurring:e.is_recurring||!1,recurrence_rule:e.recurrence_rule||null}).select().single();if(r)throw Error(`Failed to create task: ${r.message}`);return t}async function d(e,t){let{data:r,error:n}=await a.O.from("tasks").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(n)throw Error(`Failed to update task: ${n.message}`);return r}async function u(e){let{data:t,error:r}=await a.O.from("tasks").update({status:"completed",completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw Error(`Failed to complete task: ${r.message}`);return t}async function p(e){let{data:t,error:r}=await a.O.from("tasks").select("*").eq("id",e).single();return r?null:t}async function m(e){let{data:t,error:r}=await a.O.from("tasks").select("*").eq("project_id",e).neq("status","completed").order("created_at",{ascending:!1});if(r)throw Error(`Failed to get tasks: ${r.message}`);return t}async function f(){let{data:e,error:t}=await a.O.from("tasks").select("*").eq("status","pending").order("priority",{ascending:!1}).order("deadline",{ascending:!0});if(t)throw Error(`Failed to get pending tasks: ${t.message}`);return e}async function g(){let{data:e,error:t}=await a.O.from("tasks").select("*").eq("status","pending").lt("deadline",new Date().toISOString()).order("deadline",{ascending:!0});if(t)throw Error(`Failed to get overdue tasks: ${t.message}`);return e}async function w(){let e=new Date,t=new Date(e.setHours(0,0,0,0)).toISOString(),r=new Date(e.setHours(23,59,59,999)).toISOString(),{data:n,error:i}=await a.O.from("tasks").select("*").eq("status","pending").gte("deadline",t).lte("deadline",r).order("priority",{ascending:!1});if(i)throw Error(`Failed to get today's tasks: ${i.message}`);return n}async function y(){let e=new Date(Date.now()-864e5).toISOString(),{data:t,error:r}=await a.O.from("tasks").select("*").eq("status","pending").lt("deadline",new Date().toISOString()).or(`last_reminded_at.is.null,last_reminded_at.lt.${e}`).order("deadline",{ascending:!0});if(r)throw Error(`Failed to get tasks needing reminder: ${r.message}`);return t}async function h(e){let{error:t}=await a.O.from("tasks").update({last_reminded_at:new Date().toISOString()}).eq("id",e);if(t)throw Error(`Failed to update task reminder: ${t.message}`)}async function _(e){let{data:t,error:r}=await a.O.from("tasks").select("*").ilike("description",`%${e}%`).neq("status","completed").order("created_at",{ascending:!1}).limit(10);if(r)throw Error(`Failed to search tasks: ${r.message}`);return t}async function O(){let{data:e,error:t}=await a.O.from("tasks").select("*").neq("status","completed").order("created_at",{ascending:!1});if(t)throw Error(`Failed to get all tasks: ${t.message}`);return e}async function v(e){let{data:t,error:r}=await a.O.from("projects").insert({name:e.name,client_name:e.client_name||null,address:e.address||null,project_type:e.project_type||null,status:e.status||"future"}).select().single();if(r)throw Error(`Failed to create project: ${r.message}`);return t}async function $(e,t){let{data:r,error:n}=await a.O.from("projects").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(n)throw Error(`Failed to update project: ${n.message}`);return r}async function k(e){let{data:t,error:r}=await a.O.from("projects").select("*").eq("id",e).single();return r?null:t}async function E(e){let{data:t,error:r}=await a.O.from("projects").select("*").ilike("name",e).limit(1).single();return r?null:t}async function S(){let{data:e,error:t}=await a.O.from("projects").select("*").order("updated_at",{ascending:!1});if(t)throw Error(`Failed to get projects: ${t.message}`);return e}async function T(){let{data:e,error:t}=await a.O.from("projects").select("*").eq("status","active").order("updated_at",{ascending:!1});if(t)throw Error(`Failed to get active projects: ${t.message}`);return e}async function b(e){let{data:t,error:r}=await a.O.from("project_knowledge").insert({project_id:e.project_id||null,content:e.content,embedding:e.embedding,source_type:e.source_type,source_id:e.source_id||null}).select().single();if(r)throw Error(`Failed to add knowledge: ${r.message}`);return t}async function j(e){let{data:t,error:r}=await a.O.from("project_knowledge").select("*").eq("project_id",e).order("created_at",{ascending:!1});if(r)throw Error(`Failed to get project knowledge: ${r.message}`);return t}async function F(e){let{data:t,error:r}=await a.O.from("voice_transcripts").insert({raw_content:e.raw_content,duration_seconds:e.duration_seconds||null,source:e.source}).select().single();if(r)throw Error(`Failed to save transcript: ${r.message}`);return t}async function P(e,t){let{error:r}=await a.O.from("voice_transcripts").update({processed:!0,processed_at:new Date().toISOString(),processing_summary:t}).eq("id",e);if(r)throw Error(`Failed to update transcript: ${r.message}`)}async function A(e){let{data:t,error:r}=await a.O.from("daily_briefs").insert({brief_date:e.brief_date,content:e.content,tasks_included:e.tasks_included}).select().single();if(r)throw Error(`Failed to save daily brief: ${r.message}`);return t}},964:(e,t,r)=>{r.d(t,{O:()=>s});var a=r(7857);let n=process.env.SUPABASE_URL,i=process.env.SUPABASE_ANON_KEY,o=null,s=o=(0,a.eI)(n,i)},1491:(e,t,r)=>{r.d(t,{bt:()=>c,pr:()=>l});var a=r(5815);let n=process.env.OPENROUTER_API_KEY,i=process.env.APP_URL||"https://patricks-assistant.vercel.app",o=(0,a.cZ)({name:"openrouter",baseURL:"https://openrouter.ai/api/v1",headers:{Authorization:`Bearer ${n}`,"HTTP-Referer":i,"X-Title":"Patricks Assistant"}}),s={FAST:"x-ai/grok-4.1-fast",SMART:"google/gemini-3-flash-preview"},c=o(s.FAST),l=o(s.SMART)},3240:(e,t,r)=>{r.d(t,{Pl:()=>u,Py:()=>d});let a=process.env.GOOGLE_CLIENT_ID,n=process.env.GOOGLE_CLIENT_SECRET,i=process.env.GOOGLE_REFRESH_TOKEN,o=null,s=0;async function c(){if(o&&Date.now()<s-6e4)return o;let e=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:a,client_secret:n,refresh_token:i,grant_type:"refresh_token"})});if(!e.ok){let t=await e.text();throw Error(`Failed to refresh Google token: ${t}`)}let t=await e.json(),r=t.access_token;return o=r,s=Date.now()+1e3*t.expires_in,r}async function l(e,t){let r=await c(),a=new URL(`https://www.googleapis.com/calendar/v3${e}`);t&&Object.entries(t).forEach(([e,t])=>{a.searchParams.append(e,t)});let n=await fetch(a.toString(),{headers:{Authorization:`Bearer ${r}`}});if(!n.ok){let e=await n.text();throw Error(`Google Calendar API error: ${e}`)}return n.json()}async function d(){let e=new Date,t=e.getTimezoneOffset(),r=new Date(e.getTime()+(t- -480)*6e4),a=new Date(r);a.setHours(0,0,0,0);let n=new Date(r);return n.setHours(23,59,59,999),((await l("/calendars/primary/events",{timeMin:a.toISOString(),timeMax:n.toISOString(),singleEvents:"true",orderBy:"startTime"})).items||[]).map(e=>({id:e.id,summary:e.summary||"No title",start:e.start.dateTime||e.start.date||"",end:e.end.dateTime||e.end.date||"",location:e.location}))}function u(e){return 0===e.length?"No calendar events today.":e.map(e=>{let t=function(e){let t=new Date(e.start),r=t.getHours(),a=t.getMinutes().toString().padStart(2,"0");return`${r%12||12}:${a}${r>=12?"pm":"am"}`}(e),r=e.location?` at ${e.location}`:"";return`${t} ${e.summary}${r}`}).join("\n")}},2126:(e,t,r)=>{r.d(t,{_P:()=>p,_b:()=>c,bG:()=>s,kN:()=>u,mo:()=>m,zh:()=>l});let a=process.env.TELEGRAM_BOT_TOKEN,n=`https://api.telegram.org/bot${a}`,i=process.env.PATRICK_TELEGRAM_ID;async function o(e,t,r=5){let a=null;for(let i=0;i<r;i++)try{let r=new AbortController,a=setTimeout(()=>r.abort(),3e4),i=await fetch(`${n}/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:t?JSON.stringify(t):void 0,signal:r.signal});clearTimeout(a);let o=await i.json();if(!o.ok)throw Error(`Telegram API error: ${o.description}`);return o.result}catch(e){if(a=e,console.error(`Telegram API attempt ${i+1}/${r} failed:`,e),i<r-1){let e=1e3*Math.pow(2,i);console.log(`Retrying in ${e}ms...`),await new Promise(t=>setTimeout(t,e))}}throw a||Error("Failed to call Telegram API after retries")}async function s(e,t){await o("sendMessage",{chat_id:e,text:t,parse_mode:"HTML"})}async function c(e){await s(i,e)}async function l(e){await o("sendChatAction",{chat_id:e,action:"typing"})}async function d(e){return await o("getFile",{file_id:e})}async function u(e){let t=await d(e),r=`https://api.telegram.org/file/bot${a}/${t.file_path}`,n=await fetch(r);if(!n.ok)throw Error(`Failed to download voice note: ${n.status}`);let i=await n.arrayBuffer();return Buffer.from(i)}function p(e,t){return e===t}async function m(e){let t=`Your nephew Aidan failed to build me correctly. Blame him not me.

Context: ${e}`;await c(t)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,622],()=>r(7829));module.exports=a})();